<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 大和氣報名進度 - 圓形圖表版</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #6c5ce7 0%, #0984e3 50%, #00b894 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Glassmorphism base */
        .glass {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
        }

        .header {
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            color: white;
        }
        .header h1 { font-size: 2em; text-shadow: 0 2px 10px rgba(0,0,0,0.2); margin-bottom: 10px; }

        .countdown-pill {
            display: inline-block;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 700;
            color: white;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .overall-donut-wrap {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        .overall-chart-box { position: relative; width: 180px; height: 180px; }
        .overall-chart-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
        .overall-chart-center .big { font-size: 2.2em; font-weight: 800; }
        .overall-chart-center .small { font-size: 0.8em; opacity: 0.8; }

        .kpi-badges {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .kpi-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 15px;
            text-align: center;
            min-width: 100px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        .kpi-badge .val { font-size: 1.6em; font-weight: 700; }
        .kpi-badge .lbl { font-size: 0.8em; opacity: 0.8; margin-top: 3px; }

        .refresh-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .refresh-btn {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.4);
            padding: 8px 22px;
            border-radius: 25px;
            font-size: 0.95em;
            cursor: pointer;
            transition: background 0.2s;
            backdrop-filter: blur(5px);
        }
        .refresh-btn:hover { background: rgba(255, 255, 255, 0.5); }
        .auto-dot {
            display: flex; align-items: center; gap: 6px;
            color: rgba(255,255,255,0.9); font-size: 0.85em;
        }
        .auto-dot .dot {
            width: 8px; height: 8px;
            background: #55efc4;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .last-update { color: rgba(255,255,255,0.7); font-size: 0.8em; }

        /* Department grid */
        .dept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(520px, 1fr));
            gap: 25px;
        }

        .dept-card {
            padding: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
            overflow: hidden;
        }
        .dept-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .dept-card.glow-green { box-shadow: 0 0 30px rgba(46, 213, 115, 0.3); }
        .dept-card.glow-yellow { box-shadow: 0 0 30px rgba(243, 156, 18, 0.3); }
        .dept-card.glow-red { box-shadow: 0 0 30px rgba(231, 76, 60, 0.3); }

        .dept-top {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        .dept-donut-box { position: relative; width: 130px; height: 130px; flex-shrink: 0; }
        .dept-donut-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
        .dept-donut-center .pct { font-size: 1.8em; font-weight: 800; }
        .dept-donut-center .sub { font-size: 0.7em; opacity: 0.7; }

        .dept-info { flex: 1; }
        .dept-name { font-size: 1.5em; font-weight: 700; color: white; margin-bottom: 8px; }
        .dept-stat-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pill {
            background: rgba(255, 255, 255, 0.15);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            color: white;
        }
        .pill .pill-val { font-weight: 700; }

        .dept-section {
            margin-top: 18px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
        }
        .dept-section-title {
            font-size: 0.95em;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 10px;
        }
        /* Horizontal data table */
        .dept-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            color: white;
            font-size: 0.9em;
        }
        .dept-table th {
            background: rgba(255, 255, 255, 0.15);
            padding: 10px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dept-table th:first-child {
            text-align: left;
            padding-left: 12px;
        }
        .dept-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dept-table td:first-child {
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
        }
        .dept-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .dept-table .row-total {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
        .dept-table .positive { color: #55efc4; }
        .dept-table .negative { color: #fab1a0; }

        .loading {
            text-align: center;
            padding: 80px;
            color: white;
            font-size: 1.2em;
        }
        .loading .spinner {
            display: inline-block;
            width: 40px; height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-box {
            background: rgba(231, 76, 60, 0.3);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(231, 76, 60, 0.5);
        }

        @media (max-width: 768px) {
            .dept-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.4em; }
            .overall-donut-wrap { gap: 20px; }
            .dept-top { flex-direction: column; text-align: center; }
            .dept-table { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header glass">
            <h1 id="main-title">2026 大和氣報名進度</h1>
            <div class="countdown-pill" id="countdown">載入中...</div>
            <div class="overall-donut-wrap">
                <div class="overall-chart-box">
                    <canvas id="overall-donut"></canvas>
                    <div class="overall-chart-center">
                        <div class="big" id="overall-pct">--</div>
                        <div class="small">完成率</div>
                    </div>
                </div>
                <div class="kpi-badges" id="kpi-badges"></div>
            </div>
            <div class="refresh-bar">
                <button class="refresh-btn" onclick="loadData()">重新整理</button>
                <div class="auto-dot"><div class="dot"></div>自動同步 (60s)</div>
                <span class="last-update" id="last-update"></span>
            </div>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div><br>正在從 Google Sheets 讀取資料...
        </div>
        <div id="error" class="error-box" style="display:none;"></div>
        <div id="content" style="display:none;">
            <div class="dept-grid" id="dept-grid"></div>
        </div>
    </div>

<script>
const SPREADSHEET_ID = '1LqAxIhHF_CwlAUWKkmx5dvE76HzUPEWrA16mnXhF5v8';
const GID = '844567347';
const REFRESH_INTERVAL = 60000;
let chartInstances = {};
let refreshTimer = null;

function parseCSV(text) {
    const rows = [];
    let current = '', inQuotes = false, row = [];
    for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQuotes) {
            if (ch === '"') {
                if (i + 1 < text.length && text[i + 1] === '"') { current += '"'; i++; }
                else inQuotes = false;
            } else current += ch;
        } else {
            if (ch === '"') inQuotes = true;
            else if (ch === ',') { row.push(current.trim()); current = ''; }
            else if (ch === '\n' || ch === '\r') {
                if (ch === '\r' && i + 1 < text.length && text[i + 1] === '\n') i++;
                row.push(current.trim()); rows.push(row); row = []; current = '';
            } else current += ch;
        }
    }
    if (current || row.length) { row.push(current.trim()); rows.push(row); }
    return rows;
}

function safeNum(val) {
    if (!val || val === '' || val === '#DIV/0!' || val === '#REF!' || val === '#N/A') return 0;
    const n = parseFloat(String(val).replace(/[,%]/g, ''));
    return isNaN(n) ? 0 : n;
}

function calcPct(reg, target) {
    if (!target || target === 0) return 0;
    return reg / target * 100;
}

function getGlow(pct) {
    if (pct >= 100) return 'glow-green';
    if (pct >= 80) return 'glow-yellow';
    return 'glow-red';
}

const DEPT_COLORS = [
    { main: '#fd79a8', bg: 'rgba(253,121,168,0.7)' },
    { main: '#74b9ff', bg: 'rgba(116,185,255,0.7)' },
    { main: '#ffeaa7', bg: 'rgba(255,234,167,0.7)' },
    { main: '#55efc4', bg: 'rgba(85,239,196,0.7)' }
];


function extractData(rows) {
    const r1 = rows[1] || [];
    const countdownDays = safeNum(r1[14]);

    const deptNames = ['大東', '大北', '大中', '大西'];
    const depts = [];

    for (let i = 0; i < 4; i++) {
        const r = rows[5 + i] || [];
        const target = safeNum(r[1]);
        const registered = safeNum(r[2]);

        const b1 = rows[13 + i] || [];
        const breakdown1 = [
            { name: '浴佛-藍/黑衣', target: safeNum(b1[1]), reg: safeNum(b1[2]) },
            { name: '浴佛-白衣', target: safeNum(b1[5]), reg: safeNum(b1[6]) },
            { name: '動線-藍/黑衣', target: safeNum(b1[9]), reg: safeNum(b1[10]) },
            { name: '動線-白衣', target: safeNum(b1[13]), reg: safeNum(b1[14]) },
            { name: '標兵', target: safeNum(b1[17]), reg: safeNum(b1[18]) }
        ];

        const b2 = rows[19 + i] || [];
        const breakdown2 = [
            { name: '獻供慈誠', target: safeNum(b2[1]), reg: safeNum(b2[2]) },
            { name: '獻供委員', target: safeNum(b2[5]), reg: safeNum(b2[6]) }
        ];

        const a = rows[25 + i] || [];
        const adopted = [
            { name: '琉璃佛', target: safeNum(a[1]), done: safeNum(a[2]) },
            { name: '蘭花', target: safeNum(a[5]), done: safeNum(a[6]) },
            { name: '日本竹', target: safeNum(a[10]), done: safeNum(a[11]) }
        ];

        depts.push({ name: deptNames[i], target, registered, breakdown1, breakdown2, adopted });
    }

    const rt = rows[9] || [];
    const totals = { target: safeNum(rt[1]), registered: safeNum(rt[2]) };

    return { countdownDays, depts, totals };
}

function destroyCharts() {
    Object.values(chartInstances).forEach(c => c.destroy());
    chartInstances = {};
}

function renderOverall(data) {
    const t = data.totals.target || data.depts.reduce((s, d) => s + d.target, 0);
    const r = data.totals.registered || data.depts.reduce((s, d) => s + d.registered, 0);
    const deficit = t - r;
    const pct = t > 0 ? (r / t * 100) : 0;

    document.getElementById('countdown').textContent = `倒數 ${data.countdownDays} 天`;
    document.getElementById('overall-pct').textContent = pct.toFixed(1) + '%';

    document.getElementById('kpi-badges').innerHTML = `
        <div class="kpi-badge"><div class="val">${t.toLocaleString()}</div><div class="lbl">總目標</div></div>
        <div class="kpi-badge"><div class="val">${r.toLocaleString()}</div><div class="lbl">已報名</div></div>
        <div class="kpi-badge"><div class="val" style="color:${deficit > 0 ? '#fab1a0' : '#55efc4'}">${Math.abs(deficit)}</div><div class="lbl">${deficit > 0 ? '還差' : '超額'}</div></div>
    `;

    // Overall donut
    const overallCanvas = document.getElementById('overall-donut');
    if (chartInstances['overall']) chartInstances['overall'].destroy();

    const completed = Math.min(pct, 100);
    const remaining = Math.max(100 - completed, 0);

    chartInstances['overall'] = new Chart(overallCanvas, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [completed, remaining],
                backgroundColor: ['rgba(85, 239, 196, 0.8)', 'rgba(255, 255, 255, 0.15)'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '75%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { enabled: false } }
        }
    });
}

function renderDeptCard(dept, idx) {
    const pct = calcPct(dept.registered, dept.target);
    const glow = getGlow(pct);
    const deficit = dept.target - dept.registered;
    const donutId = `dept-donut-${idx}`;

    // Combine all items for table (no filtering - show all items)
    const allItems = [
        ...dept.breakdown1.map(x => ({ name: x.name, target: x.target, reg: x.reg })),
        ...dept.breakdown2.map(x => ({ name: x.name, target: x.target, reg: x.reg })),
        ...dept.adopted.map(x => ({ name: x.name, target: x.target, reg: x.done }))
    ];

    let html = `<div class="dept-card glass ${glow}">
        <div class="dept-top">
            <div class="dept-donut-box">
                <canvas id="${donutId}"></canvas>
                <div class="dept-donut-center">
                    <div class="pct">${pct.toFixed(0)}%</div>
                    <div class="sub">完成率</div>
                </div>
            </div>
            <div class="dept-info">
                <div class="dept-name">${dept.name}</div>
                <div class="dept-stat-pills">
                    <span class="pill">目標 <span class="pill-val">${dept.target}</span></span>
                    <span class="pill">報名 <span class="pill-val">${dept.registered}</span></span>
                    <span class="pill">${deficit > 0 ? '差' : '超'} <span class="pill-val" style="color:${deficit > 0 ? '#fab1a0' : '#55efc4'}">${Math.abs(deficit)}</span></span>
                </div>
            </div>
        </div>`;

    // Horizontal table for all breakdown items
    html += `<div class="dept-section">
        <table class="dept-table">
            <thead>
                <tr>
                    <th>項目</th>
                    <th>目標</th>
                    <th>已報名</th>
                    <th>差額</th>
                    <th>完成率</th>
                </tr>
            </thead>
            <tbody>
                <tr class="row-total">
                    <td>總計</td>
                    <td>${dept.target}</td>
                    <td>${dept.registered}</td>
                    <td class="${deficit <= 0 ? 'positive' : 'negative'}">${deficit <= 0 ? '+' : ''}${-deficit}</td>
                    <td>${pct.toFixed(1)}%</td>
                </tr>
                ${allItems.map(item => {
                    const itemDeficit = item.target - item.reg;
                    const itemPct = calcPct(item.reg, item.target);
                    return `<tr>
                        <td>${item.name}</td>
                        <td>${item.target}</td>
                        <td>${item.reg}</td>
                        <td class="${itemDeficit <= 0 ? 'positive' : 'negative'}">${itemDeficit <= 0 ? '+' : ''}${-itemDeficit}</td>
                        <td>${itemPct.toFixed(1)}%</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>
    </div>`;

    html += '</div>';
    return html;
}

function createDeptCharts(data) {
    data.depts.forEach((dept, idx) => {
        const pct = calcPct(dept.registered, dept.target);
        const completed = Math.min(pct, 100);
        const remaining = Math.max(100 - completed, 0);

        // Dept donut (completion rate circle - keep this)
        const donutId = `dept-donut-${idx}`;
        const donutCanvas = document.getElementById(donutId);
        if (donutCanvas) {
            const color = DEPT_COLORS[idx];
            chartInstances[donutId] = new Chart(donutCanvas, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [completed, remaining],
                        backgroundColor: [color.bg, 'rgba(255,255,255,0.1)'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '72%',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } }
                }
            });
        }
    });
}

function loadViaJSONP() {
    return new Promise((resolve, reject) => {
        const callbackName = 'gvizCb_' + Date.now();
        const script = document.createElement('script');
        const timeout = setTimeout(() => {
            cleanup();
            reject(new Error('連線逾時'));
        }, 15000);

        function cleanup() {
            clearTimeout(timeout);
            delete window[callbackName];
            if (script.parentNode) script.parentNode.removeChild(script);
        }

        window[callbackName] = function(response) {
            cleanup();
            if (response.status === 'error') {
                reject(new Error(response.errors?.[0]?.message || '資料錯誤'));
                return;
            }
            const table = response.table;
            const colNames = (table.cols || []).map(col => col.label || '');
            const dataRows = (table.rows || []).map(row =>
                (row.c || []).map(cell => (cell && cell.v !== null && cell.v !== undefined) ? String(cell.v) : '')
            );
            resolve([colNames, ...dataRows]);
        };

        script.onerror = () => { cleanup(); reject(new Error('無法連接 Google Sheets')); };
        const ts = Date.now();
        script.src = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${callbackName}&gid=${GID}&_t=${ts}`;
        document.head.appendChild(script);
    });
}

async function loadData() {
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const contentEl = document.getElementById('content');

    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    contentEl.style.display = 'none';

    try {
        const rows = await loadViaJSONP();
        if (rows.length < 10) throw new Error('數據格式不正確');

        const data = extractData(rows);
        destroyCharts();
        renderOverall(data);

        document.getElementById('dept-grid').innerHTML =
            data.depts.map((d, i) => renderDeptCard(d, i)).join('');

        contentEl.style.display = 'block';
        loadingEl.style.display = 'none';

        createDeptCharts(data);

        document.getElementById('last-update').textContent =
            '更新: ' + new Date().toLocaleString('zh-TW');
    } catch (err) {
        console.error('載入錯誤:', err);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = '載入失敗: ' + err.message;
    }
}

window.addEventListener('load', () => {
    loadData();
    refreshTimer = setInterval(loadData, REFRESH_INTERVAL);
});
</script>
</body>
</html>
